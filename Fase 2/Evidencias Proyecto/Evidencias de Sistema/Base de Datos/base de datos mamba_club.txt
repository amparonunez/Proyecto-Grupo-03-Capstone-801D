-- ======================
-- 1 Tabla USUARIOS
-- ======================
-- Ya la tienes, pero la dejo completa para contexto

create table if not exists usuarios (
  id uuid primary key references auth.users(id) on delete cascade,
  nombre text not null,
  apellidos text not null,
  rut text unique not null,
  foto_perfil bytea,
  rol text check (rol in ('jugador', 'entrenador')) default 'jugador',
  puesto text not null default 'sin definir'
  nivel text check (nivel in ('novato', 'intermedio', 'avanzado', 'elite')) default 'novato',
  created_at timestamp with time zone default now()
);

-- ======================
-- 2 Tabla EVENTOS (entrenamientos o partidos)
-- ======================
create table if not exists eventos (
  id bigserial primary key,
  tipo text check (tipo in ('entrenamiento', 'partido')) not null,
  fecha date not null,
  hora time not null,
  lugar text not null,
  descripcion text,
  entrenador_id uuid references usuarios(id) on delete set null, -- quién lo creó
  created_at timestamp with time zone default now()
);

-- ======================
-- 3 Tabla INSCRIPCIONES (entrenamientos o partidos)
-- ======================
create table if not exists inscripciones (
  id bigserial primary key,
  usuario_id uuid references usuarios(id) on delete cascade,
  evento_id bigint references eventos(id) on delete cascade,
  inscrito boolean default true,
  created_at timestamp with time zone default now(),
  unique (usuario_id, evento_id) -- evita inscripciones duplicadas
);

-- ======================
-- 4 Tabla ESTADISTICAS
-- ======================
create table if not exists estadisticas (
  id bigserial primary key,
  usuario_id uuid references usuarios(id) on delete cascade,
  evento_id bigint references eventos(id) on delete cascade, -- de qué partido o entrenamiento son
  puntos integer default 0,
  rebotes integer default 0,
  asistencias integer default 0,
  robos integer default 0,
  bloqueos integer default 0,
  created_at timestamp with time zone default now(),
  unique (usuario_id, evento_id) -- evita duplicar estadísticas del mismo jugador en el mismo evento
);

-- ======================
-- 5 Tabla ASISTENCIA
-- ======================
create table if not exists asistencia (
  id bigserial primary key,
  usuario_id uuid references usuarios(id) on delete cascade,
  evento_id bigint references eventos(id) on delete cascade,
  estadistica_id bigint references estadisticas(id) on delete cascade,
  presente boolean default false,
  timer interval, -- puedes guardar el tiempo total jugado, ej: '00:32:15'
  created_at timestamp with time zone default now(),
  unique (usuario_id, evento_id) -- un jugador no puede tener más de un registro por evento
);

-- ======================
-- 6 Tabla NOTICIAS
-- ======================
create table if not exists noticias (
  id bigserial primary key,
  titulo text not null,
  contenido text not null,
  fecha timestamp with time zone default now(),
  autor_id uuid references usuarios(id) on delete set null
);

-- ======================
-- 7 Tabla RESULTADOS FINALES
-- ======================
create table if not exists resultados_finales (
  id bigserial primary key,
  evento_id bigint references eventos(id) on delete cascade, -- partido o entrenamiento
  usuario_id uuid references usuarios(id) on delete cascade, -- jugador
  puntos integer default 0,
  rebotes integer default 0,
  asistencias integer default 0,
  robos integer default 0,
  bloqueos integer default 0,
  presente boolean default false, -- si asistió o no
  duracion interval,              -- duración total del partido (ej: '00:45:30')
  total_equipo_puntos integer default 0,
  total_equipo_rebotes integer default 0,
  total_equipo_asistencias integer default 0,
  total_equipo_robos integer default 0,
  total_equipo_bloqueos integer default 0,
  creado_por uuid references usuarios(id) on delete set null, -- entrenador que registró el resultado
  created_at timestamp with time zone default now(),
  unique (usuario_id, evento_id) -- un jugador solo puede tener un resultado final por partido
);

-- ======================
-- 🔐 Activar seguridad (RLS)
-- ======================
alter table usuarios enable row level security;
alter table eventos enable row level security;
alter table inscripciones enable row level security;
alter table asistencia enable row level security;
alter table estadisticas enable row level security;
alter table noticias enable row level security;
alter table resultados_finales enable row level security;
